## 동시성 이슈가 발생할 수 있는 로직별 락 적용 비교

-   **포인트 충전**

    -   비교 대상 락 선정
        -   기존에는 포인트 충전 요청이 동시에 들어온 경우에는 순차적으로 진행시켜 모두 충전이 되게 하였습니다.
        -   하지만, 포인트 충전시 동시에 여러 건이 들어오는 것은 어뷰징이라고 생각이 들어, 비정상적인 행위라고 판단하는 것으로 정책을 변경하였습니다.
        -   따라서, 비관적 락은 부적합하다고 생각하여 낙관적 락과 분산락을 비교해보겠습니다.
    -   비교 대상 락 종류
        -   낙관적 락
        -   분산 락
    -   결정 : 분산 락 적용
        -   포인트 충전 시, 처음에는 동일한 유저에게 5번의 충전 요청을 보내는 동시성 테스트를 하여, 소요시간이 더 짧은 락을 선택하려고 했었습니다.
        -   하지만, 멘토링 후에 해당 테스트는 의미가 없다고 생각하여 쿼리 실행량을 비교 요소로 생각해보았습니다.
        -   낙관적 락은 select 및 update 쿼리가 과도하게 많이 실행이 되게 됩니다.
        -   분산 락은 현재 simple lock으로 구현을 하였기 때문에, 락을 획득하지 못한다면 트랜잭션이 실행이 되지 않기에 DB의 부하가 적습니다.
        -   따라서, 분산 락을 적용하는 것이 좋다고 생각하여 분산 락을 적용하기로 하였습니다.

-   **선착순 쿠폰 발급**

    -   비교 대상 락 선정
        -   선착순 쿠폰 발급의 경우, 쿠폰 수량이 정해져있기 있습니다.
        -   낙관적 락을 사용하게 되면, 재고가 남아있더라도 동시 요청이 들어온 경우, 쿠폰 발급이 되지 않는 경우가 발생할 수 있습니다.
        -   따라서, 낙관적 락은 부적합하다고 생각하여 분산 락과 비관적 락을 비교해보겠습니다.
    -   비교 대상 락 종류
        -   분산 락
        -   비관적 락
    -   성능 테스트 결과
 
        <img width="599" alt="image" src="https://github.com/user-attachments/assets/4b204eb9-aa69-4d50-a895-65a8c274cd1b" />


    -   결정 : 분산 락 적용
        -   위의 성능 테스트 결과를 보면, 비관적 락이 더 빠르게 처리가 되는 것을 확인할 수 있습니다.
        -   하지만, 아래와 같은 이유들로 저는 "분산 락"을 선택하였습니다.
            -   추후 다수의 서버 인스턴스와 다수의 DB의 사용을 고려하였습니다.
            -   인기가 많은 선착순 쿠폰의 경우, 다수의 사람들이 동시에 DB에 접근을 하게 되면 부하가 많이 가해질 것으로 예상됩니다. 그렇기에 분산 락을 사용하면 DB의 부하를 줄여줄 수 있습니다.

-   **주문 생성**
    -   비교 대상 락 선정
        -   주문 생성의 경우, 상품의 재고를 신경을 써야 하기 때문에, 낙관적 락은 적합하지 않습니다.
        -   따라서, 비관적 락과 분산 락을 비교해보겠습니다.
    -   비교 대상 락 종류
        -   비관적 락
        -   분산 락
    -   성능 테스트 결과
 
        <img width="599" alt="image" src="https://github.com/user-attachments/assets/87b94b3d-65b9-4cd3-8362-409c5986bdb9" />

    -   결정 : 분산 락 적용
        -   위의 성능 테스트 결과를 보면, 분산 락이 더 빠르게 처리가 되는 것을 확인할 수 있습니다.
        -   또한, 추후 다수의 서버 인스턴스와 다수의 DB의 사용을 고려하였습니다.
        -   따라서, 분산 락을 적용하기로 하였습니다.

-   **결제 생성**

    -   비교 대상 락 선정
        -   결제 생성의 경우, 주문 당 1개의 결제 생성만 성공해야합니다. 그렇기에 낙관적 락을 사용할 수도 있습니다.
        -   하지만, 결제는 실제 포인트 사용과 관련이 있기 때문에, 낙관적 락과 비관적 락을 비교했을때 낙관적 락이 성능이 더 좋더라도 안정성이 더 중요하다고 생각하여 낙관적 락은 부적합하다고 생각하여 비관적 락과 분산 락을 비교해보겠습니다.
    -   비교 대상 락 종류
        -   비관적 락
        -   분산 락
    -   성능 테스트 결과

        <img width="601" alt="image" src="https://github.com/user-attachments/assets/05999613-9594-494f-b4e7-2f51d6fb1ed5" />


    -   결정 : 분산 락 적용
        -   위의 성능 테스트 결과를 보면, 분산 락이 더 빠르게 처리가 되는 것을 확인할 수 있습니다.
        -   또한, 추후 다수의 서버 인스턴스와 다수의 DB의 사용을 고려하였습니다.
        -   따라서, 분산 락을 적용하기로 하였습니다.
